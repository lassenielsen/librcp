program = rcpmatch
programs = $(program)
name = $(program)
version = 2015
compiler = g++
args = -O3 -Wno-deprecated
libs = -lrcp
OS_AUTO = $(shell uname -s)
COMMENT = _

objects = 
#OS_MACobjects = 

default:
	echo "Use: make config, make build or make clean."

phony: config build clean

config: include/config.hpp
ifeq ($(OS),linux)
	sed -e "s/#OS$(COMMENT)LINUX//g" Makefile.in > Makefile
else
ifeq ($(OS),osx)
	sed -e "s/#OS$(COMMENT)MAC//g" Makefile.in > Makefile
else
ifeq ($(OS_AUTO),Linux)
	sed -e "s/#OS$(COMMENT)LINUX//g" Makefile.in > Makefile
else
ifeq ($(OS_AUTO),Darwin)
	sed -e "s/#OS$(COMMENT)MAC//g" Makefile.in > Makefile
else
	echo "Unable to recognize os $(OS_AUTO)."
	echo "If linux is used please run"
	echo "OS=linux make config."
	echo "If OS X is used please run"
	echo "OS=osx make config."
	cp Makefile.in Makefile
endif
endif
endif
endif

build: $(program)


include/config.hpp: Makefile
	mkdir -p include
	echo "// Autogenerated configuration file" > include/config.hpp
	echo "#ifndef CONFIG_HPP" >> include/config.hpp
	echo "#define CONFIG_HPP" >> include/config.hpp
#OS_MAC	echo "#define OS_MAC" >> include/config.hpp
	echo "#define OS_LINUX" >> include/config.hpp
#OS_WIN	echo "#define OS_WIN" >> include/config.hpp
#GLOOX_VER_0.8.8	echo "#define GLOOX_0_8_8" >> include/config.hpp
#GLOOX_VER_0.9.0	echo "#define GLOOX_0_9_0" >> include/config.hpp
#GLOOX_VER_0.9.6	echo "#define GLOOX_0_9_6" >> include/config.hpp
	echo "#endif" >> include/config.hpp

clean:
	touch clean~
	touch packages
	touch $(program)
	rm *~
	rm -Rf packages
	rm -Rf objects
	rm -f include/config.hpp
	rm $(program)
	cp Makefile.in Makefile

objects/%.o: source/%.cpp include/*.hpp include/config.hpp
	mkdir -p objects
	$(compiler) -c source/$*.cpp $(args) -o objects/$*.o

$(program): $(objects) objects/$(program).o include/config.hpp
	$(compiler) objects/$(program).o $(objects) -o $(program) $(args) $(libs)

deb: $(program)
	echo "Making DEB package"
	mkdir -p debs/
	echo "Making data folder"
	mkdir -p debs/$(name)_$(version)_i386
	mkdir -p debs/$(name)_$(version)_i386/usr
	mkdir -p debs/$(name)_$(version)_i386/usr/local
	mkdir -p debs/$(name)_$(version)_i386/usr/local/bin
	cp $(programs) debs/$(name)_$(version)_i386/usr/local/bin/
	echo "Making control"
	mkdir -p debs/$(name)_$(version)_i386/DEBIAN
	echo "Package: $(name)"                                          > debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Version: $(version)"                                    >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Architecture: i386"                                     >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Maintainer: Lasse Nielsen <lasse.nielsen.dk@gmail.com>" >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Installed-Size: 1024"                                   >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Depends: librcp (>= 1.5)"                             >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Recommends: "                                           >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Suggests: "                                             >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Conflicts: "                                            >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Replaces: "                                             >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Provides: $(program)"                                        >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Section: interpretor"                                   >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Priority: optional"                                     >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Homepage: http://www.thelas.dk"                         >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Description: Regular Expression Matcher based on librcp. Generates more information than other matchers, as an entire parsetree is given in the efficient bitcode representation."       >> debs/$(name)_$(version)_i386/DEBIAN/control
	echo "Finalizing package"
	dpkg -b debs/$(name)_$(version)_i386/
	rm -Rf debs/$(name)_$(version)_i386
